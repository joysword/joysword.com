
<!DOCTYPE html>
<!--
    Copyright 2012 Cyrille Medard de Chardon, Geoffrey Caruso
    Licensed under the MIT license - see Licence.txt
    V1.08
-->
<html>
<head>
<title>Friendly Batch Routing with Google Maps API</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<link rel="shortcut icon" href="favicon.ico" type="image/icon">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<script src="http://maps.google.com/maps/api/js?sensor=false&amp;region=LU"></script>
<script src="jquery-1.7.2.min.js"></script>
<script type="text/javascript">

//global variable
var CmGm = {};

//Google maps
CmGm.directionsDisplay = '';
CmGm.directionsService = new google.maps.DirectionsService();
CmGm.map;
CmGm.ttype = '';
CmGm.playnice;
CmGm.query_status = '';
CmGm.error_count = 0;

//output spacing character
var spacer = '\t';

CmGm.initialize = function () {
    //setup Google Maps
    CmGm.directionsDisplay = new google.maps.DirectionsRenderer();
    var latlng = new google.maps.LatLng(49.61, 6.1296);
    var myOptions = {
      zoom: 10,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    CmGm.map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
    CmGm.directionsDisplay.setMap(CmGm.map);
    
    //setup error handling
    if (window.location.protocol === 'file:') {
        $('#warn').html("ERROR: You MUST place FBR on a server and access it through http protocol.<br>Your URL should look something like <em><strong>http://localhost/FBR/fbr.html</strong></em><br>While FBR may display the paths, <strong>your results will not be saved</strong>.");
        $("#warn").show('fast');
    }
};
  
//counts the number of rows/records submited
CmGm.countRecords = function countRecords(data_update) {
    CmGm.du_status = data_update;

    function updateTA() {
        var recs,
            line_array,
            errors_or_warnings = '',
            skipped_blank_lines = 0,
            line_counter = 0,
            semi_colon_check,
            index;

        if (CmGm.du_status === true) {
            //Determine the length (number of lines) entered
            line_array = $("#journeylist").val().split('\n');
            recs = line_array.length;
            
            //go through each line and check for existence and correct syntax
            for (index in line_array) {
                if (line_array[index].length === 0) {
                    skipped_blank_lines += 1;
                } else {
                    //not a blank line so check validity
                    semi_colon_check = line_array[index].match(/;/g);
                    if ( semi_colon_check == null || semi_colon_check.length !== 2 ) {
                        errors_or_warnings += "Line " + line_counter + " has incorrect semi-colon syntax. There should be two semi colons per line. Correct syntax is: id;origin;destination<br>";
                    }
                }
                line_counter += 1;
            }
            
            $("#rec_count").html((recs - skipped_blank_lines) + " records entered");
            
            
            if (recs - skipped_blank_lines === 1) {
                $("#rec_count").html(recs - skipped_blank_lines + " record entered");
            }
            
            //Prepare and print error/warning messages regarding count or format of input
            if (recs > 2500) {
                errors_or_warnings += "Warning: The Google Maps API has a query <a href='http://code.google.com/intl/fr/apis/maps/documentation/directions/#Limits'>limit</a> of 2,500 direction requests per day.<br>";
            }
            
            if (errors_or_warnings) {
                $("#warn").html(errors_or_warnings);
                $("#warn").show('fast');
            } else {
                $("#warn").hide('fast');
            }
            setTimeout(updateTA, 500);
        }
    }
    updateTA();
};

//stops route calculations
CmGm.stopCalc = function () {
    $("#b_stop").hide();
    CmGm.query_status = false;
};

//user clicks button to call this function
CmGm.calcRoute = function () {

    console.log('start calcRoute');

    //init vars
    var hwavoid,
        d = new Date();
        
    CmGm.error_count = 0

    //get the date to create a new output file with todays date-time stamp
    CmGm.outputFile = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate() + '-' + d.getHours() + '-' + d.getMinutes() + '-' + d.getSeconds();

    //get the the type of travel the user desires
    CmGm.ttype = $('#ttype').val();
    
    //get the status of the highway avoid checkbox
    hwavoid = $('#hwavoid').attr('checked');
    
    //clear skipped records and errors fields and hide the error section
    $("#jdist").val('');
    $("#warn_error_msg").val('');
    $('.error_sec').hide('fast');
    
    //set status to true, this is used to stop processing if needed
    CmGm.query_status = true;
    $("#b_stop").show();    //show the button to stop process
    $("#prog_box").show();  //show the progress bar

    //Get format type of origin/destination: address || lat, long
    var origtypelatlong = $("#origtype").attr('checked');   //true, false value
    var desttypelatlong = $("#desttype").attr('checked');   //true, false value
    
    //Get the selected output separator
    if($('input[name=sepval]:checked').val() === 't') {
        spacer = '\t';
    } else {
        spacer = ',';
    }
    
    var tarea = $("#journeylist").val();    //get the input
    var journies = tarea.split('\n');       //split by line
    var orig, dest, journey;
    var dump = '';                          //in case cancellation it catches all records and prints the remaining jobs to do
    playnice = 0;

    var ttl_journies = journies.length;     //number of records
    var i = 0;
    var num_journies = ttl_journies;
    var wait_time = 600 + parseInt(Math.abs(document.getElementById("waittime").value),10);
    var process_progress = 0

    var getDirection = function() {
        
        //if finished processing a route but the user terminated the job...
        if(playnice === 0 && CmGm.query_status === false) {
            //num_journies contains the number of records left to process
            while(num_journies--) {
                dump += journies[i++] + '\n';
            }
            $("#journeylist").val(dump);
            return; //end the function call
        }
        
        //switch controls asynchronous behaviour of AJAX requests.
        //Process next result if previous finished (0), otherwise wait (1), stop if an error has occurred (2).
        switch(playnice) {
            case 0:
                //everything normal, ask for next record
                // num_journies is false when 0
                if(num_journies--) {
                    //split the row based on semi-colons
                    journey = journies[i++].split(';');
                    
                    var an_error = false;
                    
                    //determine the type of the origin, assume it is a number if not then it must be an address
                    if(origtypelatlong && isNaN(journey[1].split(',')[0])) {
                        //user indicated lat/long but text submitted rather than a number
                        origtypelatlong = false;
                        $("#warn").html("Warning: Origin format has been changed to String<br>");
                        $("#warn").show('fast');
                        $("#origtype").attr('checked', false);//unchecks the checkbox
                        an_error = true;
                    } else {
                        //do nothing the user has indicated correctly the format
                        //hide the warning message whether it is visible or not
                        $("#warn").hide('fast');
                    }
                    
                    //determine the type of the destination, assume it is a number if not then it must be an address
                    if(desttypelatlong && isNaN(journey[2].split(',')[0])) {
                        //failed a string was entered but a number expected
                        desttypelatlong = false;
                        
                        //if we already had an error we must not overwrite message
                        if(an_error) {
                            $("#warn").html($("#warn").html() + "Warning: Destination format has been changed to String");
                        } else {
                            $("#warn").html("Warning: Destination format has been changed to String");
                        }
                        
                        $("#warn").show('fast');
                        $("#desttype").attr('checked', false);//unchecks the checkbox
                    } else {
                        //hide the warning message whether it is visible or not
                        if(!an_error) {
                            $("#warn").hide('fast');
                        }
                    }
                    
                    //give origin the appropriate value type
                    if(origtypelatlong) {   //lat/long
                        orig = journey[1].split(',');
                        orig = new google.maps.LatLng(orig[0], orig[1]);
                    } else {
                        orig = journey[1];
                    }
                    
                    //give destination the appropriate value type
                    if(desttypelatlong) {   // lat/long
                        dest = journey[2].split(',');
                        dest = new google.maps.LatLng(dest[0],dest[1]);
                    } else {    // string
                        dest = journey[2];
                    }
                    
                    //prepare request object
                    var request = {
                        origin:orig,
                        destination:dest,
                        avoidHighways:hwavoid,
                        travelMode: google.maps.DirectionsTravelMode[CmGm.ttype]
                    };
                    
                    //update the progress bar
                    process_progress = (ttl_journies - num_journies) * 100 / ttl_journies;
                    $("#prog_bar_size").css("width", process_progress + "%");
                    $("#prog_text").html("Process " + process_progress.toFixed(1) + "% complete")
                    
                    //call the function that sends the request to Google
                    CmGm.sendRequest(request,journey[0],i);
                    
                    //Call this function (in which we are in now) again in a set amount of time
                    setTimeout(getDirection, wait_time);
                    
                    //force wait until this record is complete
                    playnice = 1;
                } else {
                    //finished processing all records/journies, hide appropriate content.
                    $("#cmpper").show();
                    if ( CmGm.error_count > 0 ) {
                        $("#cmpper").html("Processing complete but with " + CmGm.error_count + " retrieval errors.");
                        $("#cmpper").css("background-color", "orange")
                    } else {
                        $("#cmpper").html("Processing complete without any retrieval errors.");
                        $("#cmpper").css("background-color", "lightgreen")
                    }
                    
                    // hide the progress bar
                    setTimeout(function() { $("#prog_box").hide("slow"); }, 3000);
                    
                    //hide the stop button again
                    $("#b_stop").hide();
                }
                break;
            case 1:
                //still waiting for results
                setTimeout(getDirection, wait_time);
                break;
            case 2:
                //error has occured stop
                document.getElementById('warn_error_msg').value += "Stopped data gathering due to error. Remove completed and problematic records from input and resume.\n";
                break;
            }
    }; //end of method function call

    //start the setTimeout loop
    getDirection();

    console.log('end calcRoute');

};//end of function calcRoute();

//Needs to be placed in a seperate function so that each sendRequest function object has different olat/olong data
CmGm.sendRequest = function (request, LLid, query_num) {
    var i, print_results;
    
    //ASYNCHRONOUS AJAX REQUEST
    CmGm.directionsService.route(request, function(result, status) {
        if (status == google.maps.DirectionsStatus.OK) {
            CmGm.directionsDisplay.setDirections(result);
            
            theleg = result.routes[0].legs[0];
            
            //display any warnings related to the route
            for( i = 0; i < result.routes[0].warnings.length; i++ ) {

                //Google pedestrian warning regarding the absence of sidewalks
                if(CmGm.ttype === 'WALKING') {
                    $("#warn").html(result.routes[0].warnings[0]).show('slow');
                } else {
                    document.getElementById('warn_error_msg').value += LLid + spacer + result.routes[0].warnings[i] + '\n';
                }
            }
    
            //combine and format all the data into one string
            print_results =
                LLid + spacer +
                theleg.start_location.lat() + spacer +
                theleg.start_location.lng() + spacer +
                theleg.end_location.lat() + spacer +
                theleg.end_location.lng() + spacer +
                theleg.duration.value + spacer +
                theleg.distance.value + spacer +
                theleg.steps.length;    //the number of instruction steps / complexity?.

            //try to send results to file using jquery AJAX
            $.ajax({
                type: 'POST',
                url: 'writeGMdata.php',
                data: {results: print_results, file: CmGm.outputFile, type: 'main'}
            }).fail( function(request, status, error) {
                    document.getElementById('warn_error_msg').value +=
                        LLid + spacer + 'Failed search query number: ' +
                        query_num + ' - An error occurred while trying to submit data to server! Message: ' +
                        error + '\n';
                        $("#warn").html('Error encountered see details in Errors section below.');
                        $("#warn").show('fast');
                });//end of fail/error function
            
            
            //try to send lat/long path data to server (AJAX)
            if(document.getElementById('getPath').checked) {

                //clean up print_results to put in path info
                print_results = '';
                
                //print the lat/long of each step in the following format
                for( i = 0; i < result.routes[0].overview_path.length; i++ ) {
                    var latlng = result.routes[0].overview_path[i];
                    print_results += LLid + spacer + (i+1) + spacer + latlng.lat() + spacer + latlng.lng() + '\n';
                }
    
                //send the line path data to server using jquery AJAX
                $.ajax({
                    type: 'POST',
                    url: 'writeGMdata.php',
                    data: {results: print_results, file: CmGm.outputFile, type: 'path'}
                }).fail(function(request, status, error) {
                        document.getElementById('warn_error_msg').value +=
                            LLid + spacer + 'Failed search query number: ' +
                            query_num + ' - An error occurred while trying to submit path data to server! Message: ' +
                            error + '\n';
                            $("#warn").html('Error encountered see details in Errors section below.');
                            $("#warn").show('fast');
                    });//end of fail/error function
            }
            
            //finished and got all data successfully (well from google, could still fail to write to local server)
            playnice = 0;   //0 continue processing, 1 wait and try again, 2 halt processing
            
        } else {    //encountered error - begin error handling
            
            // count errors
            CmGm.error_count += 1
            
            playnice = 0;   //0 continue processing, 1 wait and try again, 2 halt processing
            var out_string = LLid + ';';
            
            //if there are no lat/long coordinates than a string was submitted
            if(isNaN(request.origin.b)) {
                out_string += request.origin + ';';
            } else {
                out_string += request.origin.lat() + ',' + request.origin.lng() + ';';
            }
            
            //if there are no lat/long coordinates then a string destination was submitted
            if(isNaN(request.destination.b)) {
                out_string += request.destination + '\n';
            } else {
                out_string += request.destination.lat() + ',' + request.destination.lng() + '\n';
            }
            
            //clean the output string of parantheses
            out_string = out_string.replace(/[\)\(]/g, "")
            console.log(out_string)

            //write/append to the error text areas
            $('#jdist').val($('#jdist').val() + out_string);
            $('#warn_error_msg').val($('#warn_error_msg').val() + LLid + spacer + 'Failed search query number: ' + query_num + ' Status: ' + status + '\n');
            
            //show the error sections
            $('.error_sec').show('fast');
            
        }
    });
};

</script>
<style type="text/css">
body { background: #fbfbfb;  background: url(imgs/bgpaths.png);}
h2, h3 { font-family: Helvetica, Arial; font-size: 1.5em; font-weight: normal; margin:25px 0 5px 0;}
h2 { background: white url("imgs/headcube2.png") no-repeat 10px 10px; padding: 11px 0 10px 50px; }
h3 { font-size: 1.2em; padding: 0; margin: 0;}
textarea { height: 238px; width: 455px; }
#container { width: 700px; margin: auto; font-family: serif }
#header { background: white url("imgs/headcube.png") no-repeat 10px 10px; padding: 21px 0 20px 70px; }
#map_canvas { width: 200px; height: 280px; float: right; border: 5px solid #ccc;}
#warn { background-color: #fee; display: none;}
#waittime { width: 3em; }
#jdist, #warn_error_msg { width: 99%; }
#prog_bar { border: 1px solid lightblue; }
#prog_bar > div { background-color: lightblue; width: 0%; }
.tb, h2 { box-shadow: 0px 0px 6px #bbb; }
.tb { padding: 10px; margin: 5px 0; background-color: white; line-height: 1.4em; overflow: auto; }
.fwb { float: left; width: 50%;}
.nodisp { display: none; }
</style>
</head>
<body onload="CmGm.initialize();">
    <div id="container">
        <h2 id='header'>Friendly Batch Routing with Google Maps API</h2>
        <div id='optwin' class='tb'>
            <h3>Options</h3>
            <div class='fwb'>
                <strong>Input</strong>
                </br>
                <input type="checkbox" id="origtype" checked>Origin type is lat/long
                <br>
                <input type="checkbox" id="desttype" checked>Destination type is lat/long
                <br>
                <input type="checkbox" id="getPath">Record path coordinates
                <br>
                <input type="checkbox" id="hwavoid">Avoid Highways (if possible)
                <br>Travel type:
                <select id="ttype">
                    <option>DRIVING</option>
                    <option>BICYCLING</option>
                    <option>WALKING</option>
                    <option>TRANSIT</option>
                </select>
                <br>(Walking and transit information is limited)<br>
                <input type="number" id="waittime" value="400"> Pause time between queries (ms)
            </div>
            <div class='fwb'>
                <strong>Output</strong>
                </br>Separate output values with:</br>
                <input type="radio" name='sepval' value='t'
                checked>Tab
                <input type="radio" name='sepval' value='c'>Comma
                <br>
            </div>
        </div>
        <div class='tb'>
            <div id="map_canvas"></div>Enter journey list in format:
            <strong>id;origin;destination</strong>
            <br>
            <textarea id="journeylist" cols='80' rows='5' onblur="CmGm.countRecords(false);"
            onfocus="CmGm.countRecords(true);">1;49.61,6.1296;49.65861,6.13249</textarea>
            <br>
            <input type='submit' onclick='CmGm.calcRoute();'>
            <input id='b_stop' class='nodisp' type='submit' value='stop' onclick='CmGm.stopCalc();'>
            <span id='rec_count'></span>
            <div id="prog_box" class='nodisp'>
                <div id="prog_text">Process 0% complete</div>
                <div id="prog_bar">
                    <div id="prog_bar_size">&nbsp;</div>
                </div>
            </div>
        </div>
        <div id='warn' class='tb nodisp'></div>
        <h2>Results overview</h2>
        <div id='cmpper' class='tb  nodisp'></div>
        <div class='tb'>Results are located on your server in the output folder as date_time stamped
            files:<br>
            <strong>date_time_maindata.txt</strong> and <strong>date_time_pathdata.txt</strong></div>
        <h2 class='error_sec nodisp'>Errors</h2>
        <div class='tb error_sec nodisp'>Skipped records due to unreachable location, error, incorrect input
            <textarea id="jdist" rows='10'></textarea><br>
            Error Explanations<br>
            <textarea id="warn_error_msg" rows='5'></textarea>
        </div>
        <div class='tb'>Copyright 2012 Cyrille M&eacute;dard de Chardon, Geoffrey Caruso
            <br>Licensed under the MIT license - see
            <a href='Licence.txt'>Licence.txt</a>
        </div>
    </div>
    <!-- end of container -->
</body>

</html>